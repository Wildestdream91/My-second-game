<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inventaire â€” Idle ARPG v3</title>
  <link rel="stylesheet" href="css/style.css"/>
</head>
<body class="bg">
<header class="topbar">
  <h1>Idle ARPG v3 â€” Inventaire</h1>
  <nav>
    <a href="index.html">CrÃ©ation</a>
    <a href="game.html">Combat</a>
    <a href="inventory.html" class="active">Inventaire</a>
    <a href="journal.html">Journal</a>
  </nav>
</header>

<main class="columns">
  <section class="panel">
    <h3>Ã‰quipement</h3>
    <div class="equipGrid">
      <div>Arme: <span id="slotWeapon">â€”</span></div>
      <div>Bouclier: <span id="slotShield">â€”</span></div>
      <div>TÃªte: <span id="slotHead">â€”</span></div>
      <div>Torso: <span id="slotChest">â€”</span></div>
      <div>Anneau: <span id="slotRing">â€”</span></div>
      <div>Amulette: <span id="slotAmulet">â€”</span></div>
    </div>

    <h3>Stats</h3>
    <div id="charStats"></div>
  </section>

  <section class="panel">
    <h3>Sac (40 places)</h3>
    <div id="inventoryGrid" class="invGrid"></div>
    <div class="row" style="margin-top:8px;">
      <button id="sellTrash" class="btn">Vendre tout sauf rares/uniques/Ã©quipÃ©s</button>
      <button id="exportBtn" class="btn">Exporter sauvegarde</button>
      <label class="btn">Importer sauvegarde
        <input id="importFile" type="file" accept="application/json" style="display:none">
      </label>
    </div>
  </section>

  <aside class="panel log">
    <h3>Journal</h3>
    <div id="logBox" class="logBox"></div>
  </aside>
</main>

<footer class="footnote">Clic gauche: Ã©quiper. Clic droit: Ã©quiper / vendre / jeter.</footer>

<script src="js/core.js"></script>
<script src="js/loot.js"></script>
<script>
  GameCore.ensureGameOrRedirect('index.html');

  function renderSheet() {
    const s = GameCore.state;
    const eq = s.equipment;
    const byId = id=>document.getElementById(id);
    byId('slotWeapon').textContent = eq.weapon?.name || 'â€”';
    byId('slotShield').textContent = eq.shield?.name || 'â€”';
    byId('slotHead').textContent   = eq.head?.name   || 'â€”';
    byId('slotChest').textContent  = eq.chest?.name  || 'â€”';
    byId('slotRing').textContent   = eq.ring?.name   || 'â€”';
    byId('slotAmulet').textContent = eq.amulet?.name || 'â€”';
    byId('charStats').innerHTML = `
      <div><b>${s.name}</b> (${s.cls}) â€” Lv ${s.level}</div>
      <div>HP ${s.hp}/${s.hpMax} â€” Mana ${s.mana}/${s.manaMax} â€” Or ${s.gold}</div>
      <div>FOR ${s.str} â€” DEX ${s.dex} â€” VIT ${s.vit} â€” Ã‰NE ${s.ene}</div>
      <div>ATQ ${Loot.totalAttack()} â€” DEF ${Loot.totalDefense()} â€” Crit ${Loot.totalCrit()}%</div>
    `;
  }

  function renderInventory() {
    const grid = document.getElementById("inventoryGrid");
    grid.innerHTML = "";
    const s = GameCore.state;

    for (let i=0; i<40; i++) {
      const slot = document.createElement("div");
      slot.className = "slot";
      const it = s.bag[i];
      if (it) {
        slot.classList.add(it.rarity);
        slot.textContent = (it.slot==='weapon') ? 'ðŸ—¡ï¸' :
                           (it.slot==='shield') ? 'ðŸ›¡ï¸' :
                           (it.slot==='head') ? 'ðŸª–' :
                           (it.slot==='chest') ? 'ðŸ¥‹' :
                           (it.slot==='ring') ? 'ðŸ’' : 'ðŸ§¿';

        const tip = document.createElement("div");
        tip.className = "tooltip";
        tip.innerText = `${it.name}
RaretÃ©: ${it.rarity}
ATQ ${it.affixes.atk||0}  DEF ${it.affixes.def||0}
Crit ${it.affixes.crit||0}%
Valeur: ${it.affixes.value||1} or`;
        slot.appendChild(tip);
        slot.onmouseenter = ()=>{ tip.style.display="block"; };
        slot.onmouseleave = ()=>{ tip.style.display="none"; };

        slot.onclick = ()=>{ Loot.toggleEquip(i); GameCore.save(); renderSheet(); renderInventory(); };
        slot.oncontextmenu = (e)=>{
          e.preventDefault();
          const choice = prompt(`Action sur ${it.name} :\n[1] Ã‰quiper / [2] Vendre (${it.affixes.value||1} or) / [3] Jeter`);
          if(choice==="2"){ GameCore.state.gold += (it.affixes.value||1); GameCore.state.bag.splice(i,1); }
          else if(choice==="3"){ GameCore.state.bag.splice(i,1); }
          else { Loot.toggleEquip(i); }
          GameCore.save(); renderSheet(); renderInventory();
        };
      }
      grid.appendChild(slot);
    }
    document.getElementById('logBox').innerHTML = GameCore.logsHTML();
  }

  document.getElementById('sellTrash').onclick = ()=>{
    const res = Loot.sellCommons();
    GameCore.addLog(`Vente rapide : ${res.count} communs â†’ ${res.gold} or`);
    GameCore.save(); renderSheet(); renderInventory();
  };
  document.getElementById('exportBtn').onclick = ()=> GameCore.exportSave();
  document.getElementById('importFile').addEventListener('change', (e)=> GameCore.importSave(e.target.files[0]).then(()=>{renderSheet(); renderInventory();}));

  renderSheet();
  renderInventory();
</script>
</body>
</html>
