<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Idle ARPG ‚Äî Combat. Affrontez des ennemis, suivez vos statistiques et lancez des runs persistants.">
  <title>Idle ARPG ‚Äî Combat</title>

  <!-- Favicon (optionnel) -->
  <link rel="icon" href="favicon.ico" />

  <!-- Feuille de style -->
  <link rel="stylesheet" href="css/style.css"/>

  <!-- Am√©lioration du chargement (pr√©chargement optionnel) -->
  <link rel="preload" href="css/style.css" as="style">
</head>
<body class="bg">

<header class="topbar" role="banner">
  <h1>Idle ARPG ‚Äî Combat</h1>
  <nav role="navigation" aria-label="Navigation principale">
    <ul class="topnav">
      <li><a href="index.html">Cr√©ation</a></li>
      <li><a href="game.html" class="active" aria-current="page">Combat</a></li>
      <li><a href="inventory.html">Inventaire</a></li>
      <li><a href="shop.html">Campement</a></li>
      <li><a href="journal.html">Journal</a></li>
      <li><a href="ladder.html">Classement</a></li>
    </ul>
  </nav>
</header>

<!-- Carte des actes -->
<div id="actMap" class="actMap" aria-hidden="true"></div>

<main class="columns" role="main" aria-labelledby="mainTitle">
  <!-- Colonne gauche : joueur + actions -->
  <section class="panel" aria-label="√âcran de jeu">
    <!-- Stats joueur -->
    <div class="heroStats" id="playerPanel">
      <div>
        <b id="pName">‚Äî</b> (Lv <span id="pLvl">1</span>) ‚Äî <span id="pClass"></span>
      </div>
      <div>
        FOR <span id="pStr">0</span> ‚Äî DEX <span id="pDex">0</span> ‚Äî VIT <span id="pVit">0</span> ‚Äî √âNE <span id="pEne">0</span>
      </div>
      <div>
        ATQ <span id="pAtk">0</span> ‚Äî DEF <span id="pDef">0</span> ‚Äî Crit <span id="pCrit">0</span>% | MF <span id="pMF">0</span>% | Or <span id="pGold">0</span>
      </div>
      <div class="bars" aria-hidden="false">
        <div class="bar hp" role="group" aria-label="Points de vie">
          <div class="bar-fill" id="barHpFill"></div>
          <div class="bar-text" id="barHpText">HP 0/0</div>
        </div>
        <div class="bar mana" role="group" aria-label="Mana">
          <div class="bar-fill" id="barManaFill"></div>
          <div class="bar-text" id="barManaText">Mana 0/0</div>
        </div>
        <div class="bar xp" role="group" aria-label="Exp√©rience">
          <div class="bar-fill" id="barXpFill"></div>
          <div class="bar-text" id="barXpText">XP 0/0</div>
        </div>
      </div>
    </div>

    <!-- S√©lecteurs de zone / difficult√© / auto -->
    <div class="zoneRow" role="region" aria-label="Contr√¥les de zone et difficult√©">
      <label for="zoneSelect">Zone :
        <select id="zoneSelect" aria-label="S√©lection de zone">
          <!-- Options g√©n√©r√©es par JS -->
        </select>
      </label>

      <button id="newEncounter" class="btn" aria-controls="enemyCard" title="G√©n√©rer une nouvelle rencontre">Nouvelle rencontre</button>

      <label class="switch" for="autoToggle">
        <input id="autoToggle" type="checkbox" />
        <span>Auto-combat</span>
      </label>

      <label for="diffSelect">Diff :
        <select id="diffSelect" aria-label="S√©lection de la difficult√©">
          <option value="Facile">Facile</option>
          <option value="Normal" selected>Normal</option>
          <option value="Difficile">Difficile</option>
          <option value="Enfer">Enfer</option>
        </select>
      </label>
    </div>

    <!-- Runs XP (persistants) -->
    <div class="panel" style="margin-top:10px" aria-live="polite">
      <h3>Runs XP (style D2)</h3>
      <div id="runsButtons" class="btnRow" aria-hidden="false"></div>
      <div id="runsBox" class="statsBox" style="margin-top:8px">‚Äî</div>
      <button id="runsStop" class="btn danger" style="margin-top:8px" disabled title="Arr√™ter le run actuel">Stopper le run</button>
    </div>

    <!-- Carte ennemi + actions combat -->
    <div class="enemyCard" id="enemyCard" hidden aria-hidden="true" aria-live="polite">
      <div><b id="eName">‚Äî</b> (Lv <span id="eLvl">1</span>)</div>
      <div>HP: <span id="eHP">0</span>/<span id="eHPmax">0</span> | DEF: <span id="eDef">‚Äî</span> | D√©g√¢ts: <span id="eDice">‚Äî</span></div>
      <div class="actions">
        <button id="attackBtn" class="btn primary" aria-label="Attaquer l'ennemi" aria-controls="eHpBar">‚öîÔ∏è Attaquer</button>
        <button id="fleeBtn" class="btn" aria-label="Fuir le combat">üèÉ Fuir</button>
      </div>
    </div>

    <!-- Barre de vie ennemie (accessible) -->
    <progress id="eHpBar" value="0" max="1" aria-label="Barre de vie ennemie" aria-valuemin="0" aria-valuemax="1" aria-valuenow="0"></progress>

    <div id="actLore" class="lore" aria-live="polite"></div>
  </section>

  <!-- Colonne droite : journal -->
  <aside class="panel log" aria-label="Journal de combat">
    <h3 id="mainTitle">Journal</h3>
    <div id="logBox" class="logBox" role="log" aria-live="polite" aria-atomic="false"></div>
  </aside>
</main>

<footer class="footnote" role="contentinfo">Battez les boss pour d√©bloquer les actes. La difficult√© est sauvegard√©e.</footer>

<noscript>
  <div class="noscript-warning">JavaScript est requis pour jouer ‚Äî veuillez activer JavaScript dans votre navigateur.</div>
</noscript>

<!-- Scripts (d√©f√©r√©s pour que le DOM soit pr√™t) -->
<script src="js/core.js" defer></script>
<script src="js/loot.js" defer></script>
<script src="js/combat.js" defer></script>
<script src="js/runs.js" defer></script>

<!-- Petit script d'initialisation maintenu ici mais d√©clench√© au DOMContentLoaded pour robustesse -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Bloque l‚Äôacc√®s si pas de perso
    GameCore.ensureGameOrRedirect("index.html");

    // Rendu rapide du joueur (nom, classe, niveau)
    function renderPlayer(){
      const s = GameCore.state;
      document.getElementById("pName").textContent  = s.name;
      document.getElementById("pLvl").textContent   = s.level;
      document.getElementById("pClass").textContent = s.cls;
      GameCore.uiRefreshStatsIfPresent();
      // Le journal est auto-live via GameCore.updateAllLogs()
    }

    // Init combat (actes, zones, boutons)
    if (typeof Combat !== 'undefined' && Combat.initUI) {
      Combat.initUI(renderPlayer);
    } else {
      console.warn('Combat.initUI indisponible - v√©rifiez le chargement de js/combat.js');
    }

    // Applique difficult√© sauvegard√©e + listener
    (function initDifficulty(){
      const sel = document.getElementById("diffSelect");
      sel.value = GameCore.state.difficulty || "Normal";
      sel.addEventListener('change', ()=>{
        GameCore.state.difficulty = sel.value;
        GameCore.save();
        GameCore.log(`‚öôÔ∏è Difficult√©: ${sel.value}`);
      });
    })();

    // Runs persistants : reprise + UI (m√™me si on change de page)
    if (typeof Runs !== 'undefined') {
      Runs.bootstrap();
      Runs.initUI();
    }

    // Petites MAJ p√©riodiques des barres (s√©curit√©)
    setInterval(()=>GameCore.uiRefreshStatsIfPresent(), 600);

    // Initial accessibility attributes for enemy bar
    const eHpBar = document.getElementById('eHpBar');
    if (eHpBar) {
      eHpBar.setAttribute('aria-valuenow', eHpBar.value);
      eHpBar.setAttribute('aria-valuemax', eHpBar.max || 1);
    }
  });
</script>
</body>
</html>
